<script type="text/javascript">  
    var skin = {}; 
    var scrolllist, metadata, info;
    var lazyload;
    var type; 
    var sectionInfo;
    
    var infoVisible = false;

    reX.state.events = {
        skinready: function() {	
            metadata = new Template({
                templateURL: skin.path + skin.templates.metadata, 
                update: 'skin'
            });
            
            info = new Template({
                templateURL: skin.path + skin.templates.info, 
                update: 'info'
            });
                            
            var menu = new reX.Menu(
                Object.merge({
                    templateURL: skin.path + skin.templates.navigation,
                    sectionObject: reX.state.section.json,
                    inject: 'nav#'+type
                },
                skin.menu)
            );
                            
            menu.generateElements();
            menu.build();

        },
        
        menuDone: function(event) {	
            scrolllist = new reX.Scrolllist('nav#'+type, skin.scrolllist);
            
            if (reX.state.section.selectionIndex == undefined) { 
                reX.state.controls.select(1);
            }
            else {
                reX.state.controls.select( reX.state.section.selectionIndex );
            }
            
            window.fireEvent('selectionChange', reX.state.controls.getSelection());
            
            lazyload = new LazyLoad({
                range: 500, 
                realSrcAttribute: "data-src", 
                useFade: false, 
                elements: 'img', 
                container: $$('nav#'+type)[0],
                mode: "horizontal",
            });
        },
    
        selectionChange: function(item) {
            var i = item.getProperty('idx');
            reX.debug('selecting ' + reX.state.section.json[i]['@key'] + ' with type ' + reX.state.section.json[i]['@type'], REX_DEBUG);

            metadata.options.substitute = Object.merge({}, reX.state.section.json[i], reX.state.section.json[i].Media);
            metadata.parse();
            
            scrolllist.move();
        },
        
        selectionEnter: function(item) {
            var i = item.getProperty('idx');
            reX.debug('entering ' + reX.state.section.json[i]['@title'] + ' with key ' + reX.state.section.json[i]['@key'] + ' and type ' + reX.state.section.json[i]['@type'], REX_DEBUG);
            switch (reX.state.section.json[i]['@type']) {
                case 'movie': 
                    reX.state.section.imdb = mediaManager.getIMDB(reX.state.section.json[i]['@ratingKey']);
                case 'episode': 
                    var i = item.getProperty('idx');
		
                    mediaManager.getMedia(reX.state.section.json[i]['@key'], function(media) {
                        this.media = media;
                        if(this.media.Media.Part[0] != undefined) {
                            Player.playVideos(this.media.Media.Part[0]["@file"], this.media["@key"]);
                        }
                        else { 
                            Player.playVideo(this.media.Media.Part["@file"], this.media["@key"]);
                        }
                    });
                    break;
                    
                case 'season': 
                    reX.state.section.season = reX.state.section.json[i]
                    reX.load('media.html',reX.state.section.json[i]['@key'], 'episode');
                    break;
                    
                case 'show': 
                    reX.state.section.show = reX.state.section.json[i]
                    reX.state.section.tvdb = mediaManager.getTVDB(reX.state.section.json[i]['@ratingKey']);
                    reX.load('media.html',reX.state.section.json[i]['@key'], 'season');
                    break;
            } 
        },
        
        pressedBack: function() {
            if (reX.state.section.key != undefined) {
                    
                if (reX.state.video == true) {
                    reX.state.video = false;
                    Player.stop();
                }
                reX.back();
            }
        },
            
        wPressed: function(item) {
            i = item.getProperty('idx');
            mediaManager.toggleWatched(reX.state.section.json[i]['@key'], function(state){ 
                if (state === 'watched') {
                    reX.state.section.json[i]['@viewCount'] = '1';
                }
                else {
                    reX.state.section.json[i]['@viewCount'] = '0';
                }
                
                window.fireEvent('selectionChange', item);
            });
        },
        
        infoKeyPressed: function() {
            if ($('info')) {
                if (!infoVisible) {
                    i = reX.state.controls.getSelectedItem().getProperty('idx');
                    
                    info.options.substitute = Object.merge({}, reX.state.section.json[i], reX.state.section.json[i].Media, reX.state.section.json[i].Media.Part);
                    
                    info.parse();
                    
                    $('info').fade('in');
                    infoVisible = true;
                }
                else {
                    $('info').fade('out');
                    infoVisible = false;
               } 
           }
        },
        
        selectionLeave: function() {
            if ($('info')) {
                $('info').fade('hide');
                infoVisible = false;
            }
        }
    };

    window.addEvents(reX.state.events);
        
    mediaManager.getByType(reX.state.section.type, reX.state.section.key ,function(sec) {
        reX.state.section.json = sec;
        type = reX.state.section.json[0]['@type']
        
        if (reX.state.section.json.length == 1 && type != 'episode') {
            reX.load('media.html',reX.state.section.json[0]['@key'], 'episode');
            return;
        }
        
        sectionInfo = mediaManager.getSectionInformations();
        
        if (reX.state.section.type == undefined) {
            type = 'media';
        }
        else {
            type = reX.state.section.type;
        }
        
        $$('nav')[0].setProperty('id', type);
        
        skin = skinManager.getCurrentSkinForSection(reX.state.section.key);

        new Skin({
            templateURL: skin.path + skinManager.getCurrentSkinForSection().templates.skin, 
            update: 'inner',
            substitute: {'@sectionArt': sectionInfo['art']}
        });

        reX.ResourceManager.setCSS( skin.css.split(','), function() {
            window.fireEvent('skinready');
        });
    });

</script>